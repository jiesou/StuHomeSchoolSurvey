# 项目潜在问题审计报告

## 概述

本次审计旨在识别项目在部署到生产环境（预期用户千人级别）前可能存在的安全、性能、数据完整性和可维护性问题。审计基于对代码库的全面审查，包括后端服务、API逻辑和数据模型。

报告将问题分为四个主要类别，并按优先级（严重 > 高 > 中 > 低）排列。每个问题都包含 **问题描述**、**风险分析** 和 **修复建议**。

---

## 1. 严重安全漏洞 (Critical)

### S1: 管理端点无身份验证/授权
- **问题描述**: 对问卷进行创建 (`POST /api/surveys`)、更新 (`PUT /api/surveys/:id`) 和删除 (`DELETE /api/surveys/:id`) 操作的API端点是完全公开的，没有任何身份验证或授权机制。
- **风险分析**: 任何知道API地址的人都可以无限制地创建、修改或删除所有问卷数据，这会导致数据被恶意破坏、服务不可用，是生产环境中最高级别的安全风险。
- **修复建议**:
  - 实施基于Token的身份验证机制（如Bearer Token）。
  - 创建一个身份验证中间件，在处理请求前检查请求头 (`Authorization`) 中是否存在有效的Token。
  - 将此中间件应用于所有需要保护的管理路由。

### S2: 用户身份可被冒充
- **问题描述**: 在提交问卷 (`POST /api/submissions`) 时，系统仅通过请求体中明文传递的 `name` 和 `id_number` 来识别用户。
- **风险分析**: 攻击者可以轻易地通过提供他人的姓名和学号来冒充他人提交问卷，导致问卷数据被污染，失去真实性和可信度。
- **修复建议**:
  - 用户提交问卷前，应先通过安全的登录流程获取身份凭证（如JWT）。
  - 提交问卷时，应通过解析身份凭证来确定用户ID，而不是信任前端传递的用户信息。

---

## 2. 数据完整性与健壮性问题 (High)

### D1: 数据库操作非原子性
- **问题描述**: 在提交问卷的逻辑中，“查找或创建用户”与“创建提交记录”是两个独立的步骤。
- **风险分析**: 如果在创建用户后，后续的提交步骤失败，数据库中会留下一个没有提交记录的“孤立”用户。在高并发场景下，这会产生数据不一致的问题。
- **修复建议**: 使用 `prisma.$transaction([...])` 将多个关联的数据库写操作包裹在同一个事务中，确保它们要么全部成功，要么全部失败。

### D2: 用户学号（id_number）非唯一
- **问题描述**: 在 `prisma/schema.prisma` 中，`User` 模型的 `id_number` 字段没有设置唯一性约束。
- **风险分析**: 允许数据库中存在多个拥有相同学号的用户，这违反了业务逻辑的唯一性要求，可能导致数据混乱和错误的关联。
- **修复建议**: 为 `id_number` 字段添加 `@unique` 约束：`id_number String @unique`。

### D3: 输入验证不足
- **问题描述**: 各个API端点对请求的输入数据缺乏严格验证。例如，问卷标题、问题描述和答案内容的长度没有限制。
- **风险分析**:
  - **安全风险**: 可能导致恶意长文本注入，消耗服务器资源。
  - **数据质量**: 允许空内容或格式不正确的数据被存入数据库。
  - **健壮性**: 在代码中使用 `as any` 等类型断言，容易在运行时因非预期数据类型而出错。
- **修复建议**:
  - 引入一个验证库（如 `zod`），为每个API的输入（body, params, query）创建严格的验证模式。
  - 对所有文本输入添加合理的长度限制。
  - 移除不安全的类型断言，使用从验证模式中推断出的安全类型。

### D4: 级联删除可能导致意外数据丢失
- **问题描述**: `Submission`, `Question`, `Answer` 表与上游表的关联均设置为 `onDelete: Cascade`。
- **风险分析**: 删除一个 `User` 会自动删除其所有的 `Submission` 记录。虽然这可能是预期行为，但也可能在无意中导致重要历史数据的永久丢失。
- **修复建议**: 评估业务需求。如果历史数据很重要，应将 `onDelete` 策略改为 `Restrict`，防止关联数据被意外删除。或者采用软删除（soft delete）策略。

---

## 3. 性能问题 (Medium)

### P1: 词云分析存在性能瓶颈
- **问题描述**: `GET /api/surveys/:id/insights/:questionId` 端点为生成词云，会一次性将该问题的所有文本答案从数据库加载到内存中进行分词计算。
- **风险分析**: 当一份问卷的提交量非常大时（例如数千份），此操作会消耗巨大的内存和CPU资源，可能导致服务器响应缓慢甚至崩溃，影响其他所有用户。
- **修复建议**:
  - **数据聚合**: 考虑在数据库层面进行初步的词频统计，或使用流式查询处理数据。
  - **异步处理**: 将词云生成作为后台任务异步处理，并将结果缓存起来。
  - **限制数据量**: 只分析最近的N条提交或随机抽样一部分数据进行分析。

### P2: 数据库缺少显式索引
- **问题描述**: 在 `prisma/schema.prisma` 中，外键字段如 `survey_id`, `user_id`, `question_id` 等没有显式添加索引。
- **风险分析**: 在大数据量下，对这些字段的查询（尤其是 `JOIN` 操作）性能会下降。
- **修复建议**: 为所有外键和经常用于查询条件的字段添加 `@index` 属性，以优化查询性能。

### P3: 低效的问卷更新逻辑
- **问题描述**: 更新问卷时，代码会删除所有旧问题，然后重新创建所有新问题。
- **风险分析**: 这种方式效率低下，且会导致问题的ID发生变化，破坏了问题与历史答案之间的关联性和数据统计的连续性。
- **修复建议**: 重构更新逻辑，使其能够智能地区分需要“创建”、“更新”或“删除”的问题，并对它们分别进行操作，而不是粗暴地全部替换。

---

## 4. 代码质量与可维护性 (Low)

### C1: 违反项目依赖原则
- **问题描述**: 项目中通过 `npm:jieba-wasm` 导入了依赖，与 `AGENTS.md` 中“坚持使用 Deno，避免 NPM”的指导原则不符。
- **风险分析**: 破坏了项目技术栈的一致性，可能给未来的依赖管理和构建带来复杂性。
- **修复建议**:
  - 寻找 `deno.land/x` 上功能相似的纯Deno分词库。
  - 如果找不到合适的替代品，应在 `AGENTS.md` 或相关文档中明确记录此例外情况及其原因。

### C2: 日志记录不规范
- **问题描述**: 使用 `console.log` 和 `console.error` 进行日志记录。
- **风险分析**: 原始的控制台日志难以在生产环境中进行收集、解析和监控。
- **修复建议**: 引入结构化日志库（structured logging），将日志输出为JSON格式，并包含时间戳、日志级别、请求ID等上下文信息，以便与日志聚合系统集成。

### C3: 学年（year）字段格式不统一
- **问题描述**: `Survey` 模型的 `year` 字段是 `String` 类型，缺乏格式强制。
- **风险分析**: 可能导致 `“2023-2024”`, `“24”`, `“2024年”` 等不一致的数据，影响后续的数据筛选和统计。
- **修复建议**: 考虑将 `year` 定义为 `Int` 类型（如 `2023` 代表2023-2024学年），或在应用层进行严格的格式校验。

### C4: 类型定义冗余且与数据模型手动同步
- **问题描述**: `server/types.ts` 文件中手动定义了 `User`, `Survey`, `Question` 等核心数据类型，这些类型是 `prisma/schema.prisma` 中模型的副本。
- **风险分析**:
  - **可维护性差**: 当数据库模型更新时，必须手动同步这些类型定义，非常容易出错并导致应用层与数据层的不一致。
  - **关注点不分离**: 该文件还包含了运行时函数 (`parseAnswerValue`) 和可能未被使用的类型 (`CreateUserRequest`)，增加了混乱度。
- **修复建议**:
  - **利用Prisma生成类型**: 移除手写的冗余类型，直接从 Prisma Client (`@prisma/client`) 导入由 `schema.prisma` 自动生成的类型。例如，使用 `import type { Survey, User } from "./prisma/generated/client/index.d.ts";`。
  - **重构代码**: 将 `parseAnswerValue` 等工具函数移至专门的 `utils.ts` 文件。清理未使用的类型。