# 跨问卷聚合分析 (CrossInsights) 功能文档

## 功能概述

跨问卷聚合分析功能允许管理员选择多个问卷，查看相同问题在不同时间点的趋势变化。这对于追踪学生在家学习表现的变化非常有用。

## 使用场景

学校每周发送问卷了解同学在家里的表现，通过跨问卷分析可以：
- 追踪学生满意度评分的时间趋势
- 观察学生文字反馈的词频变化
- 对比不同周次的数据

## 功能特性

### 1. 多问卷选择
- 在问卷列表页面，使用表格的多选功能选择多个问卷
- 至少需要选择2个问卷才能进行聚合分析
- 点击"聚合分析"按钮进入分析页面

### 2. 问题匹配
- 系统自动识别所选问卷中的共同问题（通过问题描述匹配）
- 只展示所有问卷都包含的问题
- 验证问题类型一致性（Star/Input）

### 3. 数据展示

#### Star 类型问题 - 折线图
- 使用 vue-chartjs 和 chart.js 渲染
- X轴：问卷创建时间
- Y轴：评分（0-5）
- 每个用户一条不同颜色的折线
- 最多展示前10个用户的数据

#### Input 类型问题 - 动画词云
- 使用 vuewordcloud 组件
- 每秒自动切换展示下一个问卷的词云
- 循环播放所有问卷的结果
- 词频统计基于空格分词
- 使用不同颜色表示词频权重

### 4. 性能优化
- 懒加载：使用 IntersectionObserver 实现问题的懒加载
- 只有当问题卡片进入视口时才加载数据
- 减少初始加载时间和服务器压力

## API 接口

### GET /api/insights/:questionId?surveys=id1,id2,id3

获取跨问卷的问题聚合分析数据。

**路径参数：**
- `questionId`: 问题ID（使用第一个问卷中的问题ID作为参考）

**查询参数：**
- `surveys`: 逗号分隔的问卷ID列表

**错误响应：**
- `400`: 缺少必要参数、问卷ID无效、问题类型不一致
- `404`: 未找到匹配的问题

## 技术实现

### 服务端 (server/routes/insights.ts)
1. 解析问卷ID列表
2. 通过问题描述查找所有问卷中的匹配问题
3. 验证问题类型一致性
4. 查询前10个用户
5. 为每个用户获取各问卷中的答案历史
6. 返回结构化数据

### 客户端

#### 组件结构
- `views/admin/SurveyList.vue`: 添加多选和聚合分析按钮
- `views/admin/CrossInsights.vue`: 主分析页面
- `components/AnimatedWordcloud.vue`: 动画词云组件

#### 关键技术
- **vue-chartjs**: 折线图渲染
- **chart.js**: 图表库
- **vuewordcloud**: 词云组件
- **IntersectionObserver**: 懒加载实现

## 数据限制

- 最多返回前10个用户的数据
- 词云最多展示50个词
- 动画切换间隔：1秒
